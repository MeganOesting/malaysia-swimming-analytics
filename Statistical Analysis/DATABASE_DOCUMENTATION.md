# MOT Delta Analysis Project - Database Documentation

## Overview

The MOT Delta Analysis Project uses SQLite (`database/malaysia_swimming.db`) to store structured data for analysis, comparison, and reporting. This database serves as the single source of truth for USA swimming delta analysis results and Canada On Track reference data.

## Database Location

**Path**: `database/malaysia_swimming.db`  
**Type**: SQLite 3  
**Schema Management**: Created automatically via `db_schema.py`

## Database Tables

### 1. `canada_on_track`

**Purpose**: Stores Canada On Track reference times for Track 1 (Early), Track 2 (Middle), and Track 3 (Late) development pathways.

**Schema**:
```sql
CREATE TABLE canada_on_track (
    gender TEXT NOT NULL,           -- 'F' or 'M'
    event TEXT NOT NULL,            -- Canonical event string (e.g., '50 Free', '100 Back')
    age INTEGER NOT NULL,           -- Age (15, 16, 17, 18)
    track INTEGER NOT NULL,         -- 1=Early, 2=Middle, 3=Late
    time_text TEXT NOT NULL,        -- Original time format (e.g., '1:02.34')
    time_seconds REAL NOT NULL,     -- Parsed time in seconds (float)
    aqua_points REAL,               -- AQUA points (computed from time_seconds and base time)
    PRIMARY KEY (gender, event, track, age)
);
CREATE INDEX idx_canada_on_track_lookup ON canada_on_track (gender, event, age, track);
```

**Key Features**:
- Stores original time format (`time_text`) and parsed seconds (`time_seconds`)
- Tracks three development pathways (Track 1/2/3) per event/gender/age
- AQUA points placeholder (computed when base times are available)
- Enforces canonical event strings (via `events_catalog.py`)

**Data Source**: 
- Excel workbook: `Malaysia On Track Statistical Analysis.xlsx`
- Sheet: `Canada On Track Table, SEA MEdal Age, World Top 10`
- Columns: Gender, Event, Age, Track, Time

**Load Script**: `load_canada_tracks.py`

### 2. `usa_age_deltas`

**Purpose**: Stores computed USA swimming improvement deltas between consecutive ages (15→16, 16→17, 17→18).

**Schema**:
```sql
CREATE TABLE usa_age_deltas (
    gender TEXT NOT NULL,              -- 'F' or 'M'
    event TEXT NOT NULL,               -- Canonical event string
    age_from INTEGER NOT NULL,         -- Starting age (15, 16, or 17)
    age_to INTEGER NOT NULL,           -- Ending age (16, 17, or 18)
    sample_size INTEGER,               -- Number of matched athletes
    median_improvement REAL,           -- Median improvement in seconds
    mean_improvement REAL,             -- Mean improvement in seconds
    std_improvement REAL,              -- Standard deviation of improvements
    q25_improvement REAL,              -- 25th percentile (IQR lower bound)
    q75_improvement REAL,              -- 75th percentile (IQR upper bound)
    analysis_date TEXT,                -- Timestamp of analysis
    PRIMARY KEY (gender, event, age_from, age_to)
);
CREATE INDEX idx_usa_age_deltas_lookup ON usa_age_deltas (gender, event);
```

**Key Features**:
- Complete statistical analysis (median, mean, std dev, IQR)
- Sample size tracking for validation
- One row per age transition (84 total: 14 events × 2 genders × 3 transitions)
- Improvement = time(age_from) - time(age_to), positive = improvement

**Data Source**:
- CSV: `MOT_Delta_Analysis_Results.csv` (generated by `run_mot_delta_analysis.py`)
- Source data: `Period Data/` folder (2,240 files across 4 periods)

**Load Script**: `load_usa_deltas.py`

### 3. `usa_age_results` (Planned)

**Purpose**: Will store raw USA swimming season ranking data for z-score modeling and distribution analysis.

**Schema**:
```sql
CREATE TABLE usa_age_results (
    gender TEXT NOT NULL,           -- 'F' or 'M'
    event TEXT NOT NULL,            -- Canonical event string
    age INTEGER NOT NULL,           -- Age (15, 16, 17, 18, etc.)
    rank INTEGER NOT NULL,          -- Season rank
    time_text TEXT NOT NULL,        -- Original time format (e.g., '00:51.98')
    time_seconds REAL NOT NULL,     -- Parsed time in seconds
    season TEXT NOT NULL,           -- Season code (e.g., '2122', '2324', '2425')
    aqua_points REAL,               -- Optional AQUA points
    PRIMARY KEY (gender, event, age, rank, season)
);
CREATE INDEX idx_usa_age_results_lookup ON usa_age_results (gender, event, age, season);
```

**Status**: Schema defined, awaiting USA season ranking data import

**Planned Use**: Z-score modeling, distribution analysis, predictive validity testing

## Canonical Event Strings

The database enforces a finite set of canonical event strings to ensure consistency:

**Events (14 total)**:
- `50 Free`, `100 Free`, `200 Free`, `400 Free`, `800 Free`, `1500 Free`
- `100 Back`, `200 Back`
- `100 Breast`, `200 Breast`
- `100 Fly`, `200 Fly`
- `200 IM`, `400 IM`

**Enforcement**: `events_catalog.py` provides `normalize_event()` function that validates and normalizes event strings before database insertion.

## Season Codes

Season codes are derived from Period Data folder names:
- `9.1.21-8.31.22` → `2122`
- `9.1.22-8.31.23` → `2223`
- `9.1.23-8.31.24` → `2324`
- `9.1.24-8.31.25` → `2425`

## Database Workflow

### Initial Setup
1. Ensure SQLite database exists: `db_schema.py` creates schema automatically
2. Load Canada tracks: `python load_canada_tracks.py`
3. Run USA delta analysis: `python run_mot_delta_analysis.py`
4. Load USA deltas: `python load_usa_deltas.py`

### Data Updates
- **Canada tracks**: Re-run `load_canada_tracks.py` if Excel workbook is updated
- **USA deltas**: Re-run analysis (`run_mot_delta_analysis.py`) then reload (`load_usa_deltas.py`)
- **USA results**: Script TBD when season ranking data is available

### Querying Data

**Example queries**:

```sql
-- Get all Canada Track 1 times for F 100 Free ages 15-18
SELECT age, time_text, time_seconds 
FROM canada_on_track 
WHERE gender='F' AND event='100 Free' AND track=1 
ORDER BY age;

-- Get USA median improvements for all 15→16 transitions
SELECT event, gender, median_improvement, sample_size 
FROM usa_age_deltas 
WHERE age_from=15 AND age_to=16 
ORDER BY event, gender;

-- Compare USA vs Canada Track 1 for F 100 Free 15→16
SELECT 
    u.gender, u.event, u.median_improvement as usa_median,
    c.track, c.time_seconds as canada_time
FROM usa_age_deltas u
LEFT JOIN canada_on_track c ON 
    u.gender=c.gender AND u.event=c.event AND c.track=1
WHERE u.age_from=15 AND u.age_to=16 AND u.gender='F' AND u.event='100 Free';
```

## Integration with Analysis Tools

The database is used by:
- **Comparison reports**: `compare_deltas_canada.py` queries both tables for USA vs Canada analysis
- **Z-score modeling** (planned): Will query `usa_age_results` for distribution analysis
- **MOT table reconstruction** (planned): Will use delta data to inform new MOT times

## Data Integrity

- **Primary keys**: Prevent duplicate entries
- **Indexes**: Optimize lookup queries by gender/event/age
- **Canonical events**: Enforced via `events_catalog.py` before insertion
- **Time parsing**: Robust parsing handles various time formats (MM:SS.ss, HH:MM:SS.ss, SS.ss)

## File Organization

**Database scripts location**: `Statistical Analysis/`
- `db_schema.py` - Schema definition and connection management
- `events_catalog.py` - Canonical event string management
- `load_canada_tracks.py` - Canada data loader
- `load_usa_deltas.py` - USA delta loader
- `compare_deltas_canada.py` - Analysis using database

**Database file**: `database/malaysia_swimming.db`

## Next Steps

1. ✅ **Complete**: Canada tracks loaded (504 rows)
2. ✅ **Complete**: USA deltas loaded (83/84 rows - F 100 Back 15→16 pending fix)
3. ⏳ **Pending**: Fix missing F 100 Back 15→16 delta
4. ⏳ **Pending**: Load USA season ranking data (for z-score modeling)
5. ⏳ **Pending**: Update comparison tools to use SQLite queries instead of Excel/CSV

## Maintenance

**Backup**: The SQLite database is version-controlled and can be backed up by copying `database/malaysia_swimming.db`

**Recovery**: All source data is preserved in:
- Excel workbook: `Malaysia On Track Statistical Analysis.xlsx`
- CSV results: `MOT_Delta_Analysis_Results.csv`
- Period Data: `Period Data/` folder (2,240 files)

**Reconstruction**: If database is lost, re-run load scripts to rebuild from source data.



