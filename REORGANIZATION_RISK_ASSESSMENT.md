# Reorganization Risk Assessment & Mitigation Plan
## Pre-Migration Safety Check

---

## ğŸš¨ CRITICAL ISSUES FOUND

### 1. **Hardcoded Absolute Paths in HTML Files** âš ï¸ HIGH RISK

**Issue:**
- `Statistical Analysis/MOT_Delta_Index.html` contains 84+ hardcoded absolute file paths
- Example: `file:///C:/Users/megan/OneDrive/Documents/Malaysia Swimming Analytics/Statistical Analysis/Delta Data/...`
- **Impact:** All links will break after folder move
- **Data Loss Risk:** None (data intact, but links broken)

**Location:**
- `Statistical Analysis/MOT_Delta_Index.html` (generated by `build_delta_html.py`)

**Mitigation:**
- âœ… **Before moving:** Regenerate HTML index using updated script with new paths
- âœ… **Fix:** Update `build_delta_html.py` to use relative paths or dynamically generate paths
- âœ… **After moving:** Re-run `build_delta_html.py` to regenerate index with correct paths

**Action Required:**
```python
# Update build_delta_html.py to use relative paths instead of absolute
# Or use dynamic path generation based on script location
```

---

### 2. **Database Path in Statistical Analysis Scripts** âš ï¸ MEDIUM RISK

**Issue:**
- `Statistical Analysis/db_schema.py` uses: `os.path.join('..', 'database', 'malaysia_swimming.db')`
- This assumes Statistical Analysis is one level below root
- **Impact:** Database connection will fail after moving to `statistical_analysis/` folder
- **Data Loss Risk:** Low (database file itself won't be lost, just connection broken)

**Locations:**
- `Statistical Analysis/db_schema.py` (line 6)
- `Statistical Analysis/load_canada_tracks.py` (likely)
- `Statistical Analysis/load_usa_deltas.py` (likely)
- Any script that imports from `db_schema.py`

**Current Path Resolution:**
```
Statistical Analysis/db_schema.py
  â†’ ../database/malaysia_swimming.db
  â†’ database/malaysia_swimming.db (ROOT)
```

**After Reorganization:**
```
statistical_analysis/db_schema.py
  â†’ ../database/malaysia_swimming.db
  â†’ database/malaysia_swimming.db (ROOT) âœ… STILL WORKS!
```

**Actually, this is OK** - The relative path `../database/` will still work because:
- Statistical Analysis will be at: `statistical_analysis/`
- Database will be at: `database/` (or `statistical_analysis/database/statistical.db`)
- Path `../database/` from `statistical_analysis/` goes to root, then `database/`

**BUT:** We're planning to move database to `statistical_analysis/database/statistical.db`
- **Risk:** Scripts looking for `../database/malaysia_swimming.db` will fail
- **Solution:** Update all database paths after reorganization

**Mitigation:**
- âœ… Update `db_schema.py` to use new path: `os.path.join('database', 'statistical.db')`
- âœ… Verify all load scripts use `db_schema.py` (they should)
- âœ… Test database connection after move

---

### 3. **Docker Volume Mounts** âš ï¸ MEDIUM RISK

**Issue:**
- `docker-compose.yml` mounts volumes with relative paths:
  ```yaml
  volumes:
    - ./src:/app/src
    - ./data:/app/data
    - ./scripts:/app/scripts
    - ./database:/app/database
  ```
- **Impact:** Docker containers won't find files after reorganization
- **Data Loss Risk:** None (containers will fail to start, but data safe)

**Current Structure:**
```
./
â”œâ”€â”€ src/          â†’ /app/src
â”œâ”€â”€ data/         â†’ /app/data
â”œâ”€â”€ scripts/      â†’ /app/scripts
â””â”€â”€ database/     â†’ /app/database
```

**After Reorganization:**
```
./
â”œâ”€â”€ times_database/
â”‚   â”œâ”€â”€ src/      â†’ Need to update volume mount
â”‚   â”œâ”€â”€ scripts/  â†’ Need to update volume mount
â”‚   â””â”€â”€ database/ â†’ Need to update volume mount
â”œâ”€â”€ meets/        â†’ New location for data/meets
â””â”€â”€ reference_data/ â†’ New location for data/reference
```

**Mitigation:**
- âœ… Update `docker-compose.yml` in `times_database/` folder:
  ```yaml
  volumes:
    - ./src:/app/src
    - ../meets:/app/meets
    - ../reference_data:/app/reference_data
    - ./scripts:/app/scripts
    - ./database:/app/database
  ```
- âœ… Update FastAPI path in `main.py` (currently hardcoded `/app/database/malaysia_swimming.db`)
- âœ… Test Docker containers start correctly after reorganization

---

### 4. **FastAPI Database Path** âš ï¸ MEDIUM RISK

**Issue:**
- `src/web/main.py` line 95: `db_path = '/app/database/malaysia_swimming.db'`
- This is hardcoded for Docker container
- **Impact:** Web app won't connect to database after reorganization
- **Data Loss Risk:** None (just connection failure)

**Mitigation:**
- âœ… Update to use environment variable or relative path:
  ```python
  db_path = os.getenv('DATABASE_PATH', os.path.join(os.path.dirname(__file__), '../../database/malaysia_swimming.db'))
  ```
- âœ… Or keep Docker path if using Docker (which we are)
- âœ… Ensure Docker volume mount points to correct location

---

### 5. **Script Imports and Relative Paths** âš ï¸ LOW-MEDIUM RISK

**Issue:**
- Many scripts use relative paths like:
  - `"Period Data"` (in `run_mot_delta_analysis.py`)
  - `"Delta Data"` (in multiple scripts)
  - `"reports"` (in `build_delta_html.py`)
- **Impact:** These will still work if we keep them together in `statistical_analysis/`
- **Data Loss Risk:** None

**Verification:**
- âœ… `run_mot_delta_analysis.py` uses `os.path.join("Period Data", ...)` - OK if Period Data moves with it
- âœ… `build_delta_html.py` uses `os.path.join('reports', ...)` - OK if reports/ folder moves with it
- âœ… Most scripts use relative paths correctly

**Mitigation:**
- âœ… Ensure related folders move together:
  - `Period Data/` â†’ `statistical_analysis/data/Period Data/`
  - `Delta Data/` â†’ `statistical_analysis/data/Delta Data/`
  - `reports/` â†’ `statistical_analysis/reports/`
- âœ… Scripts stay in `statistical_analysis/scripts/`
- âœ… Relative paths will still work âœ…

---

### 6. **Excel File References** âš ï¸ LOW RISK

**Issue:**
- `Statistical Analysis/compare_deltas_canada.py` references:
  - `'Malaysia On Track Statistical Analysis.xlsx'` (relative path)
- `Statistical Analysis/load_canada_tracks.py` references same file
- **Impact:** Will break if Excel file not moved with scripts
- **Data Loss Risk:** None

**Mitigation:**
- âœ… Move Excel file: `Statistical Analysis/Malaysia On Track Statistical Analysis.xlsx` â†’ `statistical_analysis/data/`
- âœ… Update script paths to: `os.path.join('data', 'Malaysia On Track Statistical Analysis.xlsx')`
- âœ… Or keep in same folder as scripts (simpler)

---

### 7. **Reference Data Paths** âš ï¸ LOW RISK

**Issue:**
- Scripts reference `data/reference/` folder:
  - `data/reference/Age_OnTrack_AQUA.xlsx`
  - `data/reference/Clubs_By_State.xlsx`
- **Impact:** Scripts looking for these will break
- **Data Loss Risk:** None

**Mitigation:**
- âœ… Move reference files to: `reference_data/imports/` (temporary) or `reference_data/database/` (after loading)
- âœ… Update all scripts that reference `data/reference/` to use `../reference_data/`
- âœ… Search and replace: `data/reference/` â†’ `../reference_data/imports/` or appropriate path

---

### 8. **Meet Data Paths** âš ï¸ LOW RISK

**Issue:**
- Scripts reference `data/meets/` folder
- **Impact:** Scripts won't find meet files after move
- **Data Loss Risk:** None

**Mitigation:**
- âœ… Move meets to: `meets/active/2024-25/` (organized by season)
- âœ… Update scripts: `data/meets/` â†’ `../meets/active/`
- âœ… Update all conversion scripts in `times_database/scripts/`

---

## âœ… SAFE - No Issues Found

### 9. **Relative Path Patterns** âœ… SAFE

**Good Patterns Found:**
- âœ… `scripts/convert_meets_to_sqlite_fixed.py` uses `Path(__file__).parent.parent` - Dynamic, will adapt
- âœ… Most scripts use `os.path.join()` with relative paths - Safe if folders move together
- âœ… Import statements are relative (e.g., `from src.web.routers import results`) - Safe if structure maintained

---

## ğŸ“‹ COMPREHENSIVE CHECKLIST BEFORE REORGANIZATION

### Phase 0: Pre-Migration Safety Checks

- [ ] **Backup Everything**
  - [ ] Copy entire project folder as backup
  - [ ] Export databases to SQL dump files
  - [ ] Document current working paths

- [ ] **Audit All Paths**
  - [ ] Search for hardcoded absolute paths (found in HTML files)
  - [ ] Search for `data/meets` references (found in multiple scripts)
  - [ ] Search for `data/reference` references (found in multiple scripts)
  - [ ] Search for database paths (found in multiple files)

- [ ] **Document Current Working State**
  - [ ] List all scripts that work currently
  - [ ] Note which scripts query which databases
  - [ ] Document which files depend on which folders

---

## ğŸ”§ MITIGATION STRATEGY

### Step 1: Update Scripts BEFORE Moving Files

**Priority Order:**

1. **Update HTML Generator** (HIGH PRIORITY)
   - Fix `build_delta_html.py` to generate relative paths or dynamic paths
   - Regenerate `MOT_Delta_Index.html` BEFORE move

2. **Update Database Paths** (MEDIUM PRIORITY)
   - Update `Statistical Analysis/db_schema.py`:
     ```python
     # OLD: DB_PATH = os.path.join('..', 'database', 'malaysia_swimming.db')
     # NEW: DB_PATH = os.path.join(os.path.dirname(__file__), '..', 'database', 'statistical.db')
     # OR: DB_PATH = os.path.join('database', 'statistical.db')  # If moving DB with scripts
     ```

3. **Update Reference Data Paths** (MEDIUM PRIORITY)
   - Find all scripts referencing `data/reference/`
   - Update to `../reference_data/database/` or appropriate path

4. **Update Meet Data Paths** (MEDIUM PRIORITY)
   - Find all scripts referencing `data/meets/`
   - Update to `../meets/active/` or appropriate path

5. **Update Docker Configuration** (MEDIUM PRIORITY)
   - Move `docker-compose.yml` to `times_database/`
   - Update volume mounts
   - Update FastAPI database paths

### Step 2: Move Files in Correct Order

**Order Matters:**

1. **Create New Folders** (empty structure first)
   ```
   reference_data/
   meets/
   statistical_analysis/
   times_database/
   ```

2. **Move Reference Data** (independent, safe to move first)
   ```
   data/reference/* â†’ reference_data/imports/
   ```

3. **Move Meets** (independent, safe to move second)
   ```
   data/meets/* â†’ meets/active/2024-25/
   ```

4. **Move Statistical Analysis** (has database dependencies)
   ```
   Statistical Analysis/* â†’ statistical_analysis/
   database/malaysia_swimming.db â†’ statistical_analysis/database/statistical.db (COPY, don't move)
   ```

5. **Move Times Database** (has Docker dependencies)
   ```
   src/ â†’ times_database/src/
   scripts/ â†’ times_database/scripts/
   database/ â†’ times_database/database/ (for web app)
   docker-compose.yml â†’ times_database/
   ```

### Step 3: Verify After Each Move

- [ ] Test database connections
- [ ] Test script execution
- [ ] Test Docker containers (if applicable)
- [ ] Verify HTML links work
- [ ] Check for broken imports

---

## ğŸ¯ RECOMMENDED APPROACH

### Safe Migration Strategy

1. **Create a Migration Script** that:
   - Backs up current structure
   - Creates new folder structure
   - Moves files systematically
   - Updates paths in scripts automatically
   - Verifies each step

2. **Test in Stages:**
   - Stage 1: Move reference data only â†’ Test
   - Stage 2: Move meets only â†’ Test
   - Stage 3: Move Statistical Analysis â†’ Test
   - Stage 4: Move Times Database â†’ Test

3. **Keep Backup Until Verified:**
   - Don't delete old structure until everything works
   - Test all critical workflows
   - Verify no data loss

---

## âœ… FINAL VERDICT

### Risk Level: **MEDIUM** (Manageable with proper preparation)

**Critical Issues:**
- âš ï¸ Hardcoded HTML paths (easily fixable - regenerate HTML)
- âš ï¸ Database path updates needed (well-understood, straightforward fix)
- âš ï¸ Docker volume mounts (standard configuration update)

**Safe Elements:**
- âœ… Most scripts use relative paths correctly
- âœ… Database files won't be lost (just connection paths need updating)
- âœ… Data files are independent and can be moved safely

**Recommendation:**
âœ… **PROCEED with reorganization**, but:
1. Follow mitigation steps above
2. Update scripts BEFORE moving files (when possible)
3. Test after each major move
4. Keep backup until everything verified

**Estimated Time:**
- Pre-migration script updates: 1-2 hours
- File reorganization: 1 hour
- Path updates: 1-2 hours
- Testing and verification: 1-2 hours
- **Total: 4-7 hours** (can be done in stages)

---

## ğŸ“ ACTION ITEMS

Before starting reorganization:

1. âœ… Create comprehensive backup
2. âœ… Update `build_delta_html.py` to generate relative paths
3. âœ… Regenerate `MOT_Delta_Index.html`
4. âœ… Create migration script or detailed checklist
5. âœ… Update `db_schema.py` database path logic
6. âœ… Document all current working paths
7. âœ… Plan testing strategy for each stage

**Once approved, I'll create the migration script and execute step-by-step.**




